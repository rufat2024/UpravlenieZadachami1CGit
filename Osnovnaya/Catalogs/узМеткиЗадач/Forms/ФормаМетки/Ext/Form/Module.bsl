 
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
			
	ДобавитьМеткиНаФорму();		
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура КомандаМетки(Команда) Экспорт
	
	ЭлементФормы = Элементы[Команда.Имя];
	
	ЭлементФормы.Пометка = НЕ ЭлементФормы.Пометка;
	
	МеткаЗаголовок = ЭлементФормы.Заголовок;
	 	
	ПереместитьКнопкуМетки(Команда.Имя, МеткаЗаголовок);
		
КонецПроцедуры                                                         

&НаКлиенте
Процедура КомандаОК(Команда)
		
	Закрыть(МеткиСписок);
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗакрыть(Команда)
	
	Закрыть();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ДобавитьМеткиНаФорму()
	
	МеткиЗадачи = Параметры.МеткиЗадачи;
	
	ВсеМеткиЗадач = Справочники.узМеткиЗадач.ПолучитьВсеМеткиЗадач();
	
	НомерМетки = 1;
	
	ДействиеКоманды = "КомандаМетки";
	ЭлементГруппаМеткиВыбранные = Элементы.ГруппаМеткиВыбранные;
	ЭлементГруппаМеткиДоступные = Элементы.ГруппаМеткиДоступные;
	
	Для Каждого МеткаСсылка Из ВсеМеткиЗадач Цикл
			
		МеткаВыбрана = Ложь;
		ЭлементРодитель = ЭлементГруппаМеткиДоступные; 
		Если МеткиЗадачи.Найти(МеткаСсылка) <> Неопределено Тогда
			МеткаВыбрана = Истина;                     
			ЭлементРодитель = ЭлементГруппаМеткиВыбранные; 
		КонецЕсли;                      
		
		МеткиСписок.Добавить(МеткаСсылка, , МеткаВыбрана);
		
		ИмяКоманды = "КомандаМетка" + НомерМетки;		
		
		ЗаголовокМетки = "" + МеткаСсылка;
		
		Команда = Команды.Добавить(ИмяКоманды);
		Команда.Действие = ДействиеКоманды;
		Команда.Заголовок = ЗаголовокМетки;
			
		КнопкаФормы = Элементы.Добавить(ИмяКоманды, Тип("КнопкаФормы"), ЭлементРодитель);
		КнопкаФормы.Заголовок = ЗаголовокМетки; 
		КнопкаФормы.ИмяКоманды = ИмяКоманды;
		КнопкаФормы.Фигура = ФигураКнопки.Овал;
		КнопкаФормы.АвтоМаксимальнаяШирина = Истина;    
		КнопкаФормы.ЦветФона = МеткаСсылка.ЦветФонаМетки.Получить();
		КнопкаФормы.ЦветТекста = МеткаСсылка.ЦветТекстаМетки.Получить();
		КнопкаФормы.Шрифт = ШрифтыСтиля.узМеткиЗадачШрифт;
		
		КнопкаФормы.Пометка = Ложь;			
		Если МеткаВыбрана Тогда
			КнопкаФормы.Пометка = Истина; 
		КонецЕсли;		
		
		НомерМетки = НомерМетки + 1;
		
	КонецЦикла;
	
КонецПроцедуры 

&НаСервере
Процедура УстановитьВидимостьДоступность()            
	
	Элементы.ДекорацияДоступные.Видимость = Ложь;

	Если Элементы.ГруппаМеткиДоступные.ПодчиненныеЭлементы.Количество() > 0 Тогда
		Элементы.ДекорацияДоступные.Видимость = Истина;
	КонецЕсли;
	
КонецПроцедуры  

&НаСервере
Процедура ПереместитьКнопкуМетки(ИмяЭлемента, МеткаЗаголовок) 
	
	ЭлементФормы = Элементы[ИмяЭлемента];
	
	Если ЭлементФормы.Пометка Тогда
		Элементы.Переместить(ЭлементФормы, Элементы.ГруппаМеткиВыбранные); 
	Иначе
		Элементы.Переместить(ЭлементФормы, Элементы.ГруппаМеткиДоступные);
	КонецЕсли;     
	
	МеткаСсылка = Справочники.узМеткиЗадач.НайтиПоНаименованию(МеткаЗаголовок, Истина);	 
	
	ЭлСписка = МеткиСписок.НайтиПоЗначению(МеткаСсылка);
	ЭлСписка.Пометка = ЭлементФормы.Пометка;
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры    

#КонецОбласти
